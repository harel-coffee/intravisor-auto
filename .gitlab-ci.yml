image: 
  name: intravisor/cheri-sdk:latest
  entrypoint: ['bash', '-c', 'exec su cheri -c bash']

stages:
- build_intravisor
- build_runtime
- run_app

###### MUSL-LKL

AArch64-hyb_cap-intravisor-lkl:
  stage: build_intravisor
  artifacts:
      paths:
      - /builds/gitlab/cloudcap/intravisor/.config
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      # when: always # is a default value
    - when: manual
  # allow_failure: false # is a default value
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - sudo rm -rf /opt/share/AArch64-musl-lkl
    - sudo rm -rf /opt/share/AArch64-native
    - sudo mkdir -p /opt/share/AArch64-musl-lkl
    - sudo mkdir -p /opt/share/AArch64-native
    - echo > /tmp/int.cfg
    - echo "CONFIG_ARCH_ARM=y" >> /tmp/int.cfg
    - echo "CONFIG_BIT_64=y" >> /tmp/int.cfg
    - echo "CONFIG_MODE_HYB=y" >> /tmp/int.cfg
    - echo "CONFIG_OS_CHERIBSD=y" >> /tmp/int.cfg
    - echo "CONFIG_KERNEL_CONFIGURED_DDC_RELATIVE=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL_HEAP_SIZE_MB=950" >> /tmp/int.cfg
    - echo "CONFIG_CHERI_SDK=\"\$\{HOME\}/cheri/output/morello-sdk\"" >> /tmp/int.cfg
    - echo "CONFIG_CVM_MAX_SIZE=0x40000000" >> /tmp/int.cfg
    - kconfig-conf --defconfig=/tmp/int.cfg  Kconfig
    - cat .config
    - make -C src
    - sudo cp src/intravisor /opt/share/AArch64-musl-lkl/

AArch64-musl-lkl-runtime:
  stage: build_runtime
  needs: ["AArch64-hyb_cap-intravisor-lkl"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/musl-lkl
    - sudo cp runtime/musl-lkl/build/*.so /opt/share/AArch64-musl-lkl/
    - source runtime/musl-lkl/apps/SOURCE_ME.aarch64
    - make -C runtime/musl-lkl/apps/ all
    - make -C runtime/musl-lkl/apps/ install INSTALL_PATH=/opt/share/AArch64-musl-lkl


AArch64-musl-lkl-hello:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-hello.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_hello.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


AArch64-musl-lkl-python-libhello:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-python-libhello.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_python.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


AArch64-musl-lkl-python-hello:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-python-hello.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_python.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


AArch64-musl-lkl-sqlite:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-sqlite.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_sqlite.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml

AArch64-musl-lkl-darknet:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-darknet.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_darknet.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


AArch64-musl-lkl-darknet-python:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-darknet-python.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_darknet_python.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


AArch64-musl-lkl-docker-hello:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-docker-hello.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_docker_hello.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml

AArch64-musl-lkl-docker-cap_file:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-cap_file.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_cap_file.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


AArch64-musl-lkl-docker-cap_stream:
  stage: run_app
  needs: ["AArch64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-lkl/musl-lkl-cap_stream-single.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-lkl/disk_cap_stream.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-lkl.txt > default.xml


############################################



RISCV64-hyb_cap-intravisor-lkl:
  stage: build_intravisor
  artifacts:
      paths:
      - /builds/gitlab/cloudcap/intravisor/.config
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      # when: always # is a default value
    - when: manual
  # allow_failure: false # is a default value
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - sudo rm -rf /opt/share/RISCV64-musl-lkl
    - sudo rm -rf /opt/share/RISCV64-native
    - sudo mkdir -p /opt/share/RISCV64-musl-lkl
    - sudo mkdir -p /opt/share/RISCV64-native
    - echo > /tmp/int.cfg
    - echo "CONFIG_ARCH_RV=y" >> /tmp/int.cfg
    - echo "CONFIG_BIT_64=y" >> /tmp/int.cfg
    - echo "CONFIG_MODE_HYB=y" >> /tmp/int.cfg
    - echo "CONFIG_OS_CHERIBSD=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL_HEAP_SIZE_MB=950" >> /tmp/int.cfg
    - echo "CONFIG_CHERI_SDK=\"\$\{HOME\}/cheri/output/sdk\"" >> /tmp/int.cfg
    - echo "CONFIG_CVM_MAX_SIZE=0x40000000" >> /tmp/int.cfg
    - kconfig-conf --defconfig=/tmp/int.cfg  Kconfig
    - cat .config
    - make -C src
    - sudo cp src/intravisor /opt/share/RISCV64-musl-lkl/

RISCV64-musl-lkl-runtime:
  stage: build_runtime
  needs: ["RISCV64-hyb_cap-intravisor-lkl"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/musl-lkl
    - sudo cp runtime/musl-lkl/build/*.so /opt/share/RISCV64-musl-lkl/
    - source runtime/musl-lkl/apps/SOURCE_ME.rv64
    - make -C runtime/musl-lkl/apps/ all
    - make -C runtime/musl-lkl/apps/ install INSTALL_PATH=/opt/share/RISCV64-musl-lkl


RISCV64-musl-lkl-hello:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-hello.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_hello.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml


RISCV64-musl-lkl-python-libhello:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-python-libhello.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_python.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml


RISCV64-musl-lkl-python-hello:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-python-hello.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_python.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml


RISCV64-musl-lkl-sqlite:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-sqlite.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_sqlite.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml

RISCV64-musl-lkl-darknet:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-darknet.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_darknet.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml


RISCV64-musl-lkl-darknet-python:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-darknet-python.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_darknet_python.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml


RISCV64-musl-lkl-docker-redis:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-docker-redis.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_docker_redis.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml

RISCV64-musl-lkl-docker-cap_file:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-cap_file.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_cap_file.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml

RISCV64-musl-lkl-docker-cap_stream:
  stage: run_app
  needs: ["RISCV64-musl-lkl-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-lkl/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/*.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-lkl/musl-lkl-cap_stream-single.yaml  ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-lkl/disk_cap_stream.img ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-lkl.txt > default.xml


#############################################  musl-UNI

AArch64-pure_cap-intravisor:
  stage: build_intravisor
  artifacts:
      paths:
      - /builds/gitlab/cloudcap/intravisor/.config
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      # when: always # is a default value
    - when: manual
  # allow_failure: false # is a default value
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - sudo rm -rf /opt/share/AArch64-musl-uni
    - sudo rm -rf /opt/share/AArch64-native
    - sudo mkdir -p /opt/share/AArch64-musl-uni
    - sudo mkdir -p /opt/share/AArch64-native
    - echo > /tmp/int.cfg
    - echo "CONFIG_ARCH_ARM=y" >> /tmp/int.cfg
    - echo "CONFIG_BIT_64=y" >> /tmp/int.cfg
    - echo "CONFIG_MODE_PURE=y" >> /tmp/int.cfg
    - echo "CONFIG_KERNEL_CONFIGURED_DDC_RELATIVE=y" >> /tmp/int.cfg
    - echo "CONFIG_OS_CHERIBSD=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL_HEAP_SIZE_MB=950" >> /tmp/int.cfg
    - echo "CONFIG_CHERI_SDK=\"\$\{HOME\}/cheri/output/morello-sdk\"" >> /tmp/int.cfg
    - echo "CONFIG_CVM_MAX_SIZE=0x40000000" >> /tmp/int.cfg
    - kconfig-conf --defconfig=/tmp/int.cfg  Kconfig
    - cat .config
    - make -C src
    - sudo cp src/intravisor /opt/share/AArch64-musl-uni/

AArch64-musl-uni-runtime:
  stage: build_runtime
  needs: ["AArch64-pure_cap-intravisor"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/musl-uni/single/
    - make -C runtime/musl-uni/single/apps/ -j 8
    - make -C runtime/musl-uni/single/apps/ install INSTALL_PATH=/opt/share/AArch64-musl-uni




AArch64-musl-uni-hello:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-hello.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/libhello_world.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml


AArch64-musl-uni-darknet:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-darknet.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/libdarknet.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/root.cpio ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml


AArch64-musl-uni-sqlite:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-sqlite.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/libsqlite.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml


AArch64-musl-uni-redis:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-redis.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/libredis.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml


AArch64-musl-uni-ffmpeg:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-ffmpeg.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/libffmpeg.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml


AArch64-musl-uni-libvirt:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-libvirt.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/liblibvirt.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/root_libvirt.cpio ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml

AArch64-musl-uni-uros2:
  stage: run_app
  needs: ["AArch64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/AArch64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/AArch64-musl-uni/musl-uni-uros2.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/AArch64-musl-uni/liburos2.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-morello-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash morello 300 default.txt input_keys_musl-uni.txt > default.xml


##

RISCV64-pure_cap-intravisor:
  stage: build_intravisor
  artifacts:
      paths:
      - /builds/gitlab/cloudcap/intravisor/.config
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      # when: always # is a default value
    - when: manual
  # allow_failure: false # is a default value
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - sudo rm -rf /opt/share/RISCV64-musl-uni
    - sudo rm -rf /opt/share/RISCV64-native
    - sudo mkdir -p /opt/share/RISCV64-musl-uni
    - sudo mkdir -p /opt/share/RISCV64-native
    - echo > /tmp/int.cfg
    - echo "CONFIG_ARCH_RV=y" >> /tmp/int.cfg
    - echo "CONFIG_BIT_64=y" >> /tmp/int.cfg
    - echo "CONFIG_MODE_PURE=y" >> /tmp/int.cfg
    - echo "CONFIG_OS_CHERIBSD=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL=y" >> /tmp/int.cfg
    - echo "CONFIG_LKL_HEAP_SIZE_MB=950" >> /tmp/int.cfg
    - echo "CONFIG_CHERI_SDK=\"\$\{HOME\}/cheri/output/sdk\"" >> /tmp/int.cfg
    - echo "CONFIG_CVM_MAX_SIZE=0x40000000" >> /tmp/int.cfg
    - kconfig-conf --defconfig=/tmp/int.cfg  Kconfig
    - cat .config
    - make -C src
    - sudo cp src/intravisor /opt/share/RISCV64-musl-uni/

RISCV64-musl-uni-runtime:
  stage: build_runtime
  needs: ["RISCV64-pure_cap-intravisor"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/musl-uni/single/
    - make -C runtime/musl-uni/single/apps/ -j 8
    - make -C runtime/musl-uni/single/apps/ install INSTALL_PATH=/opt/share/RISCV64-musl-uni



RISCV64-musl-uni-hello:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-hello.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/libhello_world.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml


RISCV64-musl-uni-darknet:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-darknet.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/libdarknet.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/root.cpio ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml


RISCV64-musl-uni-sqlite:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-sqlite.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/libsqlite.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml


RISCV64-musl-uni-redis:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-redis.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/libredis.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml


RISCV64-musl-uni-ffmpeg:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-ffmpeg.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/libffmpeg.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml


RISCV64-musl-uni-libvirt:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-libvirt.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/liblibvirt.so ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/root_libvirt.cpio ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml

RISCV64-musl-uni-uros2:
  stage: run_app
  needs: ["RISCV64-musl-uni-runtime"]
  artifacts:
    when: always
    paths:
      - extras/default.xml
      - extras/default.txt
    reports:
      junit: extras/default.xml
  script:
    - mkdir -p ~/cheri/extra-files/etc/rc.d/
    - cp extras/int ~/cheri/extra-files/etc/rc.d/
    - mkdir -p ~/cheri/extra-files/intravisor
#
    - sudo cp /opt/share/RISCV64-musl-uni/intravisor ~/cheri/extra-files/intravisor/
    - sudo cp /opt/share/RISCV64-musl-uni/musl-uni-uros2.yaml ~/cheri/extra-files/intravisor/cvm.yaml
    - sudo cp /opt/share/RISCV64-musl-uni/liburos2.so ~/cheri/extra-files/intravisor/
#
    - ~/cheribuild/cheribuild.py disk-image-riscv64-hybrid --enable-hybrid-targets
    - cd extras && bash spawn.bash riscv64 300 default.txt input_keys_musl-uni.txt > default.xml


###########  pure-cap and hybrid cap native

AArch64-native-two_pure:
  stage: build_runtime
  needs: ["AArch64-pure_cap-intravisor"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/native/two-pure/
    - make -C runtime/native/two-pure/ install INSTALL_PATH=/opt/share/AArch64-native/

RISCV64-native-two_pure:
  stage: build_runtime
  needs: ["RISCV64-pure_cap-intravisor"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/native/two-pure/
    - make -C runtime/native/two-pure/ install INSTALL_PATH=/opt/share/RISCV64-native/

AArch64-native-hello:
  stage: build_runtime
  needs: ["AArch64-hyb_cap-intravisor-lkl"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/native/hello_world/
    - make -C runtime/native/hello_world/ install INSTALL_PATH=/opt/share/AArch64-native/

RISCV64-native-hello:
  stage: build_runtime
  needs: ["RISCV64-hyb_cap-intravisor-lkl"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/native/hello_world/
    - make -C runtime/native/hello_world/ install INSTALL_PATH=/opt/share/RISCV64-native/

##### pure-cap ORC (ARM only)


AArch64-pure_cap-intravisor-ORC:
  stage: build_intravisor
  artifacts:
      paths:
      - /builds/gitlab/cloudcap/intravisor/.config
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      # when: always # is a default value
    - when: manual
  # allow_failure: false # is a default value
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - echo "Hello, $GITLAB_USER_LOGIN!"
    - sudo rm -rf /opt/share/AArch64-native-ORC
    - sudo mkdir -p /opt/share/AArch64-native-ORC
    - echo > /tmp/int.cfg
    - echo "CONFIG_ARCH_ARM=y" >> /tmp/int.cfg
    - echo "CONFIG_BIT_64=y" >> /tmp/int.cfg
    - echo "CONFIG_MODE_PURE=y" >> /tmp/int.cfg
    - echo "CONFIG_OS_CHERIBSD=y" >> /tmp/int.cfg
    - echo "CONFIG_ORC=y" >> /tmp/int.cfg
    - echo "CONFIG_KERNEL_CONFIGURED_DDC_RELATIVE=n" >> /tmp/int.cfg
    - echo "CONFIG_CHERI_SDK=\"\$\{HOME\}/cheri/output/morello-sdk\"" >> /tmp/int.cfg
    - echo "CONFIG_CVM_MAX_SIZE=0x10000000" >> /tmp/int.cfg
    - kconfig-conf --defconfig=/tmp/int.cfg  Kconfig
    - cat .config
    - make -C src
    - sudo cp src/intravisor /opt/share/AArch64-native-ORC/

AArch64-native-ORC-hello:
  stage: build_runtime
  needs: ["AArch64-pure_cap-intravisor-ORC"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/native/orc-hello/
    - make -C runtime/native/orc-hello/ install INSTALL_PATH=/opt/share/AArch64-native-ORC/


AArch64-musl-uni-sqlite-x5:
  stage: build_runtime
  needs: ["AArch64-pure_cap-intravisor-ORC"]
  artifacts:
    when: always
    paths:
#      - extras/default.xml
#      - extras/default.txt
    reports:
#      junit: extras/default.xml
  script:
    - git config --global --add safe.directory /builds/gitlab/cloudcap/intravisor
    - make -C runtime/musl-uni/multi/sqlite/x5/
    - make -C runtime/musl-uni/multi/sqlite/x5/ install INSTALL_PATH=/opt/share/AArch64-native-ORC/
